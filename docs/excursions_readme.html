<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shore Excursions Checklist Component - Pending Day Approach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        h1 {
            color: #0f0f10;
            font-size: 2.5em;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e87435;
        }
        
        h2 {
            color: #0f0f10;
            font-size: 1.8em;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        
        h3 {
            color: #333;
            font-size: 1.4em;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        h4 {
            color: #555;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        p {
            margin-bottom: 15px;
            line-height: 1.8;
        }
        
        ul, ol {
            margin-bottom: 15px;
            margin-left: 25px;
        }
        
        li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d14;
        }
        
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            color: #abb2bf;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f4f4f4;
            font-weight: 600;
            color: #0f0f10;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .diagram {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            overflow-x: auto;
            margin-bottom: 20px;
            white-space: pre;
        }
        
        .toc {
            background-color: #f4f4f4;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .toc h3 {
            margin-top: 0;
            color: #0f0f10;
        }
        
        .toc ul {
            margin-bottom: 0;
        }
        
        .toc a {
            color: #e87435;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        .badge {
            display: inline-block;
            background-color: #e87435;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 15px;
        }
        
        strong {
            color: #0f0f10;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shore Excursions Checklist Component - Overview</h1>
        
        <div class="badge">Pending Day Approach - Updated Architecture</div>
        
        <div class="toc">
            <h3>Table of Contents</h3>
            <ul>
                <li><a href="#purpose">Purpose</a></li>
                <li><a href="#data-source">Data Source</a></li>
                <li><a href="#architecture">Component Architecture</a></li>
                <li><a href="#conditional-layouts">Conditional Layouts</a></li>
                <li><a href="#state-logic">Excursion State Logic</a></li>
                <li><a href="#scenarios">Example Scenarios</a></li>
                <li><a href="#date-calculations">Date Calculations</a></li>
                <li><a href="#performance">Performance Considerations</a></li>
                <li><a href="#testing">Testing Checklist</a></li>
                <li><a href="#troubleshooting">Troubleshooting</a></li>
            </ul>
        </div>
        
        <h2 id="purpose">Purpose</h2>
        <p>The Shore Excursions component dynamically generates a personalized checklist of port days for each guest's sailing, displaying their excursion booking status and providing quick access to book additional excursions. <strong>AT SEA days are completely filtered from rendering.</strong></p>
        
        <h2 id="data-source">Data Source</h2>
        
        <h3>Data Extension</h3>
        <ul>
            <li><strong>Name:</strong> <code>SHOREX_Excursions_Lookup</code></li>
            <li><strong>Query Keys:</strong>
                <ul>
                    <li><code>SHIP_CODE</code> - Ship identifier</li>
                    <li><code>SAIL_DATE</code> - Sailing departure date</li>
                    <li><code>CONSUMER_ID</code> - Guest identifier</li>
                </ul>
            </li>
            <li><strong>Sort Order:</strong> <code>ITINERARY_DAY_NBR ASC</code> (Days rendered in sequential order)</li>
        </ul>
        
        <h3>Key Fields</h3>
        <table>
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Description</th>
                    <th>Usage</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>ITINERARY_DAY_NBR</code></td>
                    <td>Day number (1-based)</td>
                    <td>Loop iteration, day header display</td>
                </tr>
                <tr>
                    <td><code>PORT_NAME</code></td>
                    <td>Port of call name</td>
                    <td>Display (cleaned to remove country)</td>
                </tr>
                <tr>
                    <td><code>PORT_CODE</code></td>
                    <td>Port identifier</td>
                    <td>Available for URL parameters</td>
                </tr>
                <tr>
                    <td><code>ACTIVE_EXCURSIONS</code></td>
                    <td>Pipe-delimited excursion IDs or empty</td>
                    <td>Determines booked/unbooked state</td>
                </tr>
                <tr>
                    <td><code>SAIL_DATE</code></td>
                    <td>Sailing departure date</td>
                    <td>Date calculations</td>
                </tr>
                <tr>
                    <td><code>ONBOARD_CREDIT</code></td>
                    <td>Available credit amount</td>
                    <td>Available for future features</td>
                </tr>
                <tr>
                    <td><code>CC_LOYALTY_ACCOUNT_NBR</code></td>
                    <td>Captain's Club number</td>
                    <td>Available for URL parameters</td>
                </tr>
                <tr>
                    <td><code>RDSS_VERSION</code></td>
                    <td>Data version identifier</td>
                    <td>Tracking</td>
                </tr>
            </tbody>
        </table>
        
        <h3>Required Initialization Variables</h3>
        <p>These variables <strong>must</strong> be set by <code>SHOREX_ampscript.html</code> before this component is rendered:</p>
        <ul>
            <li><code>@SHIP_CODE</code></li>
            <li><code>@SHIP_DEPARTURE_DATE</code></li>
            <li><code>@CONSUMER_ID</code></li>
        </ul>
        
        <h2 id="architecture">Component Architecture</h2>
        
        <h3>Loop Logic</h3>
        
        <h4>Pending Day Pairing System</h4>
        <p>The component renders shore excursion days in a <strong>2-column layout</strong> by processing ALL rows sequentially and tracking a "pending" day:</p>
        
        <p><strong>Flow:</strong></p>
        <pre>Loop row 1: Port day → Save as PENDING LEFT
Loop row 2: AT SEA → Skip (filter)
Loop row 3: Port day → Render PAIR(pending + current), clear pending
Loop row 4: AT SEA → Skip (filter)
Loop row 5: Port day → Save as PENDING LEFT
Loop row 6: Port day → Render PAIR(pending + current), clear pending
(After loop) Pending still set? → Render FINAL ODD</pre>
        
        <h4>Index Loop</h4>
        <pre><code>FOR @i = 1 TO @rowCount DO
    SET @currentRow = Row(@rows, @i)
    // Extract and clean port name
    // IF AT SEA → NEXT @i (skip)
    // IF port day AND no pending → Save as LEFT, set @PENDING_DAY
    // IF port day AND pending exists → Load as RIGHT, render PAIR, clear pending
NEXT @i</code></pre>
        
        <h4>AT SEA Filtering</h4>
        <pre><code>IF @CURRENT_PORT_NAME != "AT SEA" THEN
    // Process port day (pending logic)
ENDIF</code></pre>
        
        <p>All "AT SEA" port days are completely filtered from rendering. Port days are never lost:</p>
        <ul>
            <li>Single port between AT SEA days becomes PENDING LEFT</li>
            <li>Next port encountered pairs with pending, renders as PAIR</li>
            <li>Final port with no pair renders as FINAL ODD after loop ends</li>
        </ul>
        
        <h4>Variable Namespacing</h4>
        <p>All extracted data uses <code>@LEFT_</code> and <code>@RIGHT_</code> prefixes to avoid conflicts:</p>
        <ul>
            <li><code>@LEFT_ITINERARY_DAY_NBR</code> vs <code>@RIGHT_ITINERARY_DAY_NBR</code></li>
            <li><code>@LEFT_PORT_NAME</code> vs <code>@RIGHT_PORT_NAME</code></li>
            <li><code>@LEFT_HAS_EXCURSIONS</code> vs <code>@RIGHT_HAS_EXCURSIONS</code></li>
            <li><code>@PENDING_DAY</code> - Flag tracking if LEFT is waiting for RIGHT pairing</li>
        </ul>
        
        <h2 id="conditional-layouts">Conditional Layouts</h2>
        
        <h3>Layout Detection Flag</h3>
        <pre><code>IF EMPTY(@PENDING_DAY) THEN
    // This is our first port day, save as LEFT
ELSE
    // We have a pending day, pair with this one, render PAIR, then clear pending
ENDIF

// After loop: IF NOT EMPTY(@PENDING_DAY) THEN render FINAL ODD</code></pre>
        
        <p>The presence of <code>@PENDING_DAY</code> determines layout:</p>
        
        <h3>PAIR Layout</h3>
        <p>Renders when a LEFT port day has found a RIGHT port day to pair with</p>
        
        <div class="diagram">┌─────────────────────────────┬─────────────────────────────┐
│ LEFT COLUMN (50%)           │ RIGHT COLUMN (50%)          │
├─────────────────────────────┼─────────────────────────────┤
│ • Day header + date         │ • Day header + date         │
│ • Image                     │ • Image                     │
│ • Port name                 │ • Port name                 │
│ • Booked/Unbooked state     │ • Booked/Unbooked state     │
│ • Book Now button           │ • Book Now button           │
└─────────────────────────────┴─────────────────────────────┘</div>
        
        <h3>FINAL ODD Layout</h3>
        <p>Renders when a port day remains unpaired at the end of the loop (odd total port count)</p>
        
        <div class="diagram">┌─────────────────────────────┬─────────────────────────────┐
│ IMAGE COLUMN (50%)          │ CONTENT COLUMN (50%)        │
├─────────────────────────────┼─────────────────────────────┤
│ • Image only                │ • Day header + date         │
│                             │ • Port name                 │
│                             │ • Booked/Unbooked state     │
│                             │ • Book Now button           │
└─────────────────────────────┴─────────────────────────────┘</div>
        
        <h2 id="state-logic">Excursion State Logic</h2>
        
        <h3>State Detection</h3>
        <pre><code>SET @LEFT_HAS_EXCURSIONS = IIF(NOT EMPTY(@LEFT_ACTIVE_EXCURSIONS), "TRUE", "FALSE")</code></pre>
        
        <ul>
            <li><strong>BOOKED</strong> (<code>@LEFT_HAS_EXCURSIONS == "TRUE"</code>): <code>ACTIVE_EXCURSIONS</code> field contains pipe-delimited data</li>
            <li><strong>UNBOOKED</strong> (<code>@LEFT_HAS_EXCURSIONS == "FALSE"</code>): <code>ACTIVE_EXCURSIONS</code> field is empty/null</li>
        </ul>
        
        <h3>Visual States</h3>
        
        <h4>Booked State</h4>
        <ul>
            <li><strong>Background:</strong> Dark navy (<code>#081632</code>)</li>
            <li><strong>Icon:</strong> Checkmark (✓) in orange circle</li>
            <li><strong>Text:</strong> "Excursions booked" (white)</li>
            <li><strong>Mobile Behavior:</strong> Image hidden via <code>hide-booked-image-mobile</code> CSS class</li>
        </ul>
        
        <h4>Unbooked State</h4>
        <ul>
            <li><strong>Background:</strong> Light gray (<code>#d6d6d6</code>)</li>
            <li><strong>Icon:</strong> Empty circle (light gray)</li>
            <li><strong>Text:</strong> "No excursions booked" (dark gray)</li>
            <li><strong>Button:</strong> Orange "BOOK NOW" CTA displayed below state indicator</li>
        </ul>
        
        <h3>Port Name Cleanup & AT SEA Filtering</h3>
        <pre><code>SET @CURRENT_PORT_NAME = Field(@currentRow, 'PORT_NAME')
IF indexOf(@CURRENT_PORT_NAME, ",") > 0 THEN
    SET @CURRENT_PORT_NAME = Substring(@CURRENT_PORT_NAME, 1, Subtract(IndexOf(@CURRENT_PORT_NAME, ","), 1))
ENDIF
SET @CURRENT_PORT_NAME = Trim(Uppercase(@CURRENT_PORT_NAME))

IF @CURRENT_PORT_NAME != "AT SEA" THEN
    // Process as port day (pairing logic)
ENDIF</code></pre>
        
        <p><strong>Port name cleanup removes country suffix:</strong></p>
        <ul>
            <li>Input: <code>"San Juan, Puerto Rico"</code></li>
            <li>After substring: <code>"San Juan"</code></li>
        </ul>
        
        <p><strong>AT SEA filtering:</strong></p>
        <ul>
            <li>Normalized to uppercase and trimmed</li>
            <li>Comparison: <code>"AT SEA"</code> (exact match)</li>
            <li>Handles variations: <code>"AT SEA "</code> (trailing space), <code>"at sea"</code> (lowercase)</li>
            <li>Rows where port name IS "AT SEA" are completely skipped via <code>NEXT @i</code></li>
        </ul>
        
        <h3>Mobile Optimization</h3>
        
        <h4>Responsive Images</h4>
        <p>Images are conditionally hidden on mobile when excursions are booked:</p>
        <pre><code>&lt;tr%%[ IF @LEFT_HAS_EXCURSIONS == "TRUE" THEN ]%% class="hide-booked-image-mobile"%%[ ENDIF ]%%&gt;</code></pre>
        
        <p>Applied to:</p>
        <ul>
            <li>LEFT column image in PAIR layout</li>
            <li>RIGHT column image in PAIR layout</li>
            <li>Image column in FINAL ODD layout</li>
        </ul>
        
        <p>This CSS class (defined elsewhere) uses media queries to hide images on small screens when the guest has already booked excursions, prioritizing content over imagery.</p>
        
        <h2 id="scenarios">Example Scenarios</h2>
        
        <h3>4-Night Cruise (Even Port Days, No AT SEA)</h3>
        <pre>Row 1: Nassau        → Save as PENDING LEFT
Row 2: Cozumel       → Pair with pending → Render PAIR, clear pending
Row 3: Grand Cayman  → Save as PENDING LEFT
Row 4: Jamaica       → Pair with pending → Render PAIR, clear pending
(After loop) Pending empty → No FINAL ODD</pre>
        
        <h3>5-Night Cruise (Odd Port Days, No AT SEA)</h3>
        <pre>Row 1: Nassau        → Save as PENDING LEFT
Row 2: Cozumel       → Pair with pending → Render PAIR, clear pending
Row 3: Grand Cayman  → Save as PENDING LEFT
Row 4: Jamaica       → Pair with pending → Render PAIR, clear pending
Row 5: St. Thomas    → Save as PENDING LEFT
(After loop) Pending set → Render FINAL ODD</pre>
        
        <h3>7-Night Cruise with AT SEA Days</h3>
        <pre>Row 1: Nassau        → Save as PENDING LEFT
Row 2: AT SEA        → Skip (filter)
Row 3: Cozumel       → Pair with pending → Render PAIR, clear pending
Row 4: Grand Cayman  → Save as PENDING LEFT
Row 5: Jamaica       → Pair with pending → Render PAIR, clear pending
Row 6: AT SEA        → Skip (filter)
Row 7: St. Thomas    → Save as PENDING LEFT
(After loop) Pending set → Render FINAL ODD
Result: 3 port days rendered in 2 pairs (PAIR + PAIR + FINAL ODD), 2 AT SEA days hidden</pre>
        
        <h3>Mixed Booking States with AT SEA</h3>
        <pre>Row 1: Nassau        (BOOKED)   → Save as PENDING LEFT
Row 2: Cozumel       (UNBOOKED) → Pair → Render PAIR (booked+unbooked), clear pending
Row 3: AT SEA        → Skip
Row 4: Grand Cayman  (BOOKED)   → Save as PENDING LEFT
Row 5: Jamaica       (BOOKED)   → Pair → Render PAIR (booked+booked), clear pending
Row 6: St. Thomas    (UNBOOKED) → Save as PENDING LEFT
(After loop) Pending set → Render FINAL ODD (unbooked)</pre>
        
        <h2 id="date-calculations">Date Calculations</h2>
        
        <h3>Day Date Display</h3>
        <pre><code>SET @LEFT_CURRENT_DAY_DATE = DateAdd(@LEFT_SAIL_DATE, Subtract(@LEFT_ITINERARY_DAY_NBR, 1), 'D')</code></pre>
        
        <p><strong>Example:</strong></p>
        <ul>
            <li>Sail Date: <code>2026-02-15</code></li>
            <li>Day 1: <code>2026-02-15</code> (sail date + 0 days)</li>
            <li>Day 2: <code>2026-02-16</code> (sail date + 1 day)</li>
            <li>Day 7: <code>2026-02-21</code> (sail date + 6 days)</li>
        </ul>
        
        <p>Displayed as: <code>DAY 1: FEB 15</code> using <code>FormatDate(@LEFT_CURRENT_DAY_DATE, 'M')</code></p>
        
        <h2 id="performance">Performance Considerations</h2>
        
        <h3>Loop Efficiency</h3>
        <ul>
            <li><strong>Single DE Query:</strong> All data retrieved once at the top</li>
            <li><strong>Sequential Processing:</strong> Each row processed exactly once (O(n) complexity)</li>
            <li><strong>No Index Math:</strong> Direct <code>Row(@rows, @i)</code> access avoids calculation overhead</li>
            <li><strong>Early Exit Logic:</strong> AT SEA rows exit immediately with <code>NEXT @i</code></li>
        </ul>
        
        <h3>Variable Scope</h3>
        <p>All variables are set <strong>inside the loop</strong> to ensure fresh data per iteration:</p>
        <ul>
            <li>Pending day state persists across iterations (intentional for pairing)</li>
            <li>LEFT/RIGHT data cleared when pair renders</li>
            <li>Prevents data bleed between unrelated pairs</li>
        </ul>
        
        <h2 id="testing">Testing Checklist</h2>
        
        <p>When testing this component, verify:</p>
        <ul>
            <li>☐ <strong>Even port count</strong> (2, 4, 6 port days): All pairs render correctly, no FINAL ODD</li>
            <li>☐ <strong>Odd port count</strong> (3, 5, 7 port days): All pairs render + FINAL ODD for unpaired day</li>
            <li>☐ <strong>AT SEA filtering:</strong> AT SEA rows never render, port days after AT SEA pair correctly</li>
            <li>☐ <strong>Booked state:</strong> Dark background, checkmark, image hidden on mobile</li>
            <li>☐ <strong>Unbooked state:</strong> Gray background, empty circle, "BOOK NOW" button visible</li>
            <li>☐ <strong>Mixed states:</strong> Different states per day render independently</li>
            <li>☐ <strong>Mixed with AT SEA:</strong> Port days not lost when surrounded by AT SEA rows</li>
            <li>☐ <strong>Date calculations:</strong> All dates increment correctly from sail date</li>
            <li>☐ <strong>Port names:</strong> Country names removed (e.g., "San Juan" not "San Juan, Puerto Rico")</li>
            <li>☐ <strong>Mobile view:</strong> Images hidden when excursions booked (all columns/layouts)</li>
            <li>☐ <strong>No port days scenario:</strong> Component gracefully handles zero port days (all AT SEA)</li>
            <li>☐ <strong>Single port day:</strong> Renders as FINAL ODD after loop</li>
        </ul>
        
        <h2 id="troubleshooting">Troubleshooting</h2>
        
        <h3>Issue: Loop only renders first port day</h3>
        <p><strong>Cause:</strong> AT SEA filtering skipping all rows or pending logic failing</p>
        <p><strong>Fix:</strong> Verify port names are cleaned and normalized with <code>Trim(Uppercase())</code></p>
        
        <h3>Issue: Port days are missing/lost</h3>
        <p><strong>Cause:</strong> AT SEA rows adjacent to port days causing pending logic to fail</p>
        <p><strong>Fix:</strong> Check that pending day is properly maintained and next port is correctly paired</p>
        
        <h3>Issue: Booked state not displaying</h3>
        <p><strong>Cause:</strong> <code>ACTIVE_EXCURSIONS</code> field format mismatch</p>
        <p><strong>Fix:</strong> Confirm DE field contains pipe-delimited data or is truly empty (not spaces)</p>
        
        <h3>Issue: FINAL ODD doesn't render</h3>
        <p><strong>Cause:</strong> Pending flag not checked after loop</p>
        <p><strong>Fix:</strong> Ensure final conditional <code>IF NOT EMPTY(@PENDING_DAY)</code> exists after loop ends</p>
        
        <h3>Issue: AT SEA days rendering</h3>
        <p><strong>Cause:</strong> Port name comparison failing due to case or whitespace</p>
        <p><strong>Fix:</strong> Verify <code>Trim(Uppercase())</code> is applied before <code>!= "AT SEA"</code> comparison</p>
        
        <hr style="margin: 40px 0; border: none; border-top: 2px solid #ddd;">
        
        <p style="text-align: center; color: #999; margin-top: 40px;">
            <strong>Documentation Updated:</strong> February 2, 2026<br>
            <strong>Architecture:</strong> Pending Day Pairing System with AT SEA Filtering
        </p>
    </div>
</body>
</html>
