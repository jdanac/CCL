%%[
/* ===== TESTING ONLY: Hard-coded lookup parameters ===== */
SET @SHIPEX_CODE = 'XC'
SET @SHIPEX_DEPARTURE_DATE = '1/24/2027 12:00:00 AM'
/* ===== END TESTING ONLY - REMOVE when using dynamic values ===== */

/* Initialize default values for all three activity rows */
SET @SHIPEX_title_1 = 'ShipEx Title 1'
SET @SHIPEX_path_1 = 'https://image.na.celebritycruises.com/lib/fe31117276640579751279/m/1/3a19e7ad-62a5-4ac7-b22e-b998f5b55911.png'
SET @SHIPEX_desc_1 = 'TBD.'

SET @SHIPEX_title_2 = 'ShipEx Title 2'
SET @SHIPEX_path_2 = 'https://image.na.celebritycruises.com/lib/fe31117276640579751279/m/1/3a19e7ad-62a5-4ac7-b22e-b998f5b55911.png'
SET @SHIPEX_desc_2 = 'TBD'

SET @SHIPEX_title_3 = 'ShipEx Title 3'
SET @SHIPEX_path_3 = 'https://image.na.celebritycruises.com/lib/fe31117276640579751279/m/1/3a19e7ad-62a5-4ac7-b22e-b998f5b55911.png'
SET @SHIPEX_desc_3 = 'TBD'

/* Build link to ship excursions booking page */
SET @SHIPEX_link = Concat('https://www.celebritycruises.com/account/cruise-planner/category/shipexcursions?bookingId=', @BOOKING_ID, '&shipCode=', @SHIPEX_CODE, '&sailDate=', FormatDate(@SHIPEX_DEPARTURE_DATE, 'YYYYMMdd'), '&currencyCode=', @CURRENCY_CODE)

/* Validate ship code and sail date, then query DE for ship excursion products */
SET @shipExcursionRowCount = 0
IF NOT EMPTY(@SHIPEX_CODE) AND NOT EMPTY(@SHIPEX_DEPARTURE_DATE) THEN
	SET @shipExcursionRows = LookupRows('SHIPEXCURSIONS_GraphiQL_Products', 'shipCode', @SHIPEX_CODE, 'sailDate', @SHIPEX_DEPARTURE_DATE)
	SET @shipExcursionRowCount = RowCount(@shipExcursionRows)
ENDIF

/* ===== LOOP & FILTER ITEMS ===== */

SET @displayCount = 0
IF @shipExcursionRowCount > 0 THEN
	FOR @i = 1 TO @shipExcursionRowCount DO
		SET @currentRow = Row(@shipExcursionRows, @i)
		SET @currentStock = Field(@currentRow, 'STOCK')
		SET @currentTitle = Field(@currentRow, 'TITLE')

		/* EXCLUDE record if OUT_OF_STOCK (IN_STOCK, LOW_STOCK, etc. are OK) */
		IF IndexOf(@currentStock, 'OUT_OF_STOCK') == 0 THEN
			/* EXCLUDE "Ship Orientation Tour" from display */
			IF @currentTitle != 'Ship Orientation Tour' THEN
				SET @displayCount = Add(@displayCount, 1)

				/* data for Activity Row 1 */
				IF @displayCount == 1 THEN
					SET @SHIPEX_title_1 = Field(@currentRow, 'TITLE')
					SET @SHIPEX_path_1 = Field(@currentRow, 'PATH')
					SET @SHIPEX_desc_1_full = Field(@currentRow, 'DESCRIPTION')
					SET @periodPos_1 = IndexOf(@SHIPEX_desc_1_full, '.')
					IF @periodPos_1 > 0 THEN
						SET @SHIPEX_desc_1 = Substring(@SHIPEX_desc_1_full, 1, @periodPos_1)
					ELSE
						SET @SHIPEX_desc_1 = @SHIPEX_desc_1_full
					ENDIF
				/* data for Activity Row 2 */
				ELSEIF @displayCount == 2 THEN
					SET @SHIPEX_title_2 = Field(@currentRow, 'TITLE')
					SET @SHIPEX_path_2 = Field(@currentRow, 'PATH')
					SET @SHIPEX_desc_2_full = Field(@currentRow, 'DESCRIPTION')
					SET @periodPos_2 = IndexOf(@SHIPEX_desc_2_full, '.')
					IF @periodPos_2 > 0 THEN
						SET @SHIPEX_desc_2 = Substring(@SHIPEX_desc_2_full, 1, @periodPos_2)
					ELSE
						SET @SHIPEX_desc_2 = @SHIPEX_desc_2_full
					ENDIF
				/* data for Activity Row 3 */
				ELSEIF @displayCount == 3 THEN
					SET @SHIPEX_title_3 = Field(@currentRow, 'TITLE')
					SET @SHIPEX_path_3 = Field(@currentRow, 'PATH')
					SET @SHIPEX_desc_3_full = Field(@currentRow, 'DESCRIPTION')
					SET @periodPos_3 = IndexOf(@SHIPEX_desc_3_full, '.')
					IF @periodPos_3 > 0 THEN
						SET @SHIPEX_desc_3 = Substring(@SHIPEX_desc_3_full, 1, @periodPos_3)
					ELSE
						SET @SHIPEX_desc_3 = @SHIPEX_desc_3_full
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	NEXT @i
ENDIF
/* ===== END FILTERING ===== */
]%%

<!-- ====== SEA DAY ACTIVITIES COMPONENT ====== -->
<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto; background-color: #002859;">
	<tr>
        <td>
<!-- Title -->
<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto; background-color: #002859;">
	<tr>
		<td class="mobile-padding-0-40" align="left" style="padding: 20px 30px 10px 30px;">
			<table cellpadding="0" cellspacing="0" border="0" width="100%" role="presentation">
				<tr>
					<td align="left" style="font-family: 'Poppins', Arial, sans-serif; font-size: 25px; line-height: 32px; color: #ffffff; padding: 0; font-weight: 700;">Sea Day Activities</td>
				</tr>
			</table>
		</td>
	</tr>
</table>

<!-- Activity Row 1 -->
<!-- Image + Copy (left/right layout) -->
<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto; background-color: #002859;">
	<tr>
		<td style="padding: 10px 0 0 0;">
			<table cellspacing="0" cellpadding="0" role="presentation" style="width: 100%; background-color: #002859;">
				<tr>
					<td valign="middle" class="responsive-td" style="width: 50%; padding: 10px 10px 10px 20px;">
						<table width="100%" cellspacing="0" cellpadding="0" role="presentation">
							<tr>
								<td class="mobile-padding-0-40" align="left">
									<img src="%%=v(@SHIPEX_path_1)=%%" alt="Sea day activity" width="248" style="display: block; padding: 0px; text-align: center; height: auto; width: 100%; border: 0px;">
								</td>
							</tr>
						</table>
					</td>

					<td valign="middle" class="responsive-td" style="width: 50%; padding-left: 0px;">
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 10px 20px 0" align="left">
									<span style="font-size: 17px; line-height: 22px; font-family: 'Poppins', Arial, sans-serif;font-weight: 700; color: #ffffff;">%%=v(@SHIPEX_title_1)=%%</span>
								</td>
							</tr>
						</table>
                        <!-- Copy -->
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 5px 20px 0 20px;" align="left">
									<span style="font-size: 15px; line-height: 26px; font-family: 'Poppins', Arial, sans-serif; color: #ffffff;">%%=v(@SHIPEX_desc_1)=%%</span>
								</td>
							</tr>
						</table>
                       <!-- CTA button-->
						<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="background-color: #002859;">
							<tr>
								<td style="padding: 10px 20px;" class="mobile-padding-0-40">
									&nbsp;
								</td>
							</tr>
						</table>
				
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>

<!-- Activity Row 2 -->
<!-- Image + Copy (left/right layout) -->
<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto; background-color: #002859;">
	<tr>
		<td style="padding: 10px 0 0 0;">
			<table cellspacing="0" cellpadding="0" role="presentation" style="width: 100%; background-color: #002859;">
				<tr>
					<td valign="middle" class="responsive-td" style="width: 50%; padding: 10px 10px 10px 20px;">
						<table width="100%" cellspacing="0" cellpadding="0" role="presentation">
							<tr>
								<td class="mobile-padding-0-40" align="left">
									<img src="%%=v(@SHIPEX_path_2)=%%" alt="Sea day activity" width="248" style="display: block; padding: 0px; text-align: center; height: auto; width: 100%; border: 0px;">
								</td>
							</tr>
						</table>
					</td>

					<td valign="middle" class="responsive-td" style="width: 50%; padding-left: 0px;">
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 10px 20px 0" align="left">
									<span style="font-size: 17px; line-height: 22px; font-family: 'Poppins', Arial, sans-serif;font-weight: 700; color: #ffffff;">%%=v(@SHIPEX_title_2)=%%</span>
								</td>
							</tr>
						</table>
                        <!-- Copy -->
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 5px 20px 0 20px;" align="left">
									<span style="font-size: 15px; line-height: 26px; font-family: 'Poppins', Arial, sans-serif; color: #ffffff;">%%=v(@SHIPEX_desc_2)=%%</span>
								</td>
							</tr>
						</table>
                       <!-- CTA button-->
						<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="background-color: #002859;">
							<tr>
								<td style="padding: 10px 20px;" class="mobile-padding-0-40">
									&nbsp;
								</td>
							</tr>
						</table>
				
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>

<!-- Activity Row 3 -->
<!-- Image + Copy (left/right layout) -->
<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto; background-color: #002859;">
	<tr>
		<td style="padding: 10px 0 10px 0;">
			<table cellspacing="0" cellpadding="0" role="presentation" style="width: 100%; background-color: #002859;">
				<tr>
					<td valign="middle" class="responsive-td" style="width: 50%; padding: 10px 10px 10px 20px;">
						<table width="100%" cellspacing="0" cellpadding="0" role="presentation">
							<tr>
								<td class="mobile-padding-0-40" align="left">
									<img src="%%=v(@SHIPEX_path_3)=%%" alt="Sea day activity" width="248" style="display: block; padding: 0px; text-align: center; height: auto; width: 100%; border: 0px;">
								</td>
							</tr>
						</table>
					</td>

					<td valign="middle" class="responsive-td" style="width: 50%; padding-left: 0px;">
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 10px 20px 0" align="left">
									<span style="font-size: 17px; line-height: 22px; font-family: 'Poppins', Arial, sans-serif;font-weight: 700; color: #ffffff;">%%=v(@SHIPEX_title_3)=%%</span>
								</td>
							</tr>
						</table>
                        <!-- Copy -->
						<table border="0" cellpadding="0" cellspacing="0" width="100%" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40 textC" style="padding: 5px 20px 0 20px;" align="left">
									<span style="font-size: 15px; line-height: 26px; font-family: 'Poppins', Arial, sans-serif; color: #ffffff;">%%=v(@SHIPEX_desc_3)=%%</span>
								</td>
							</tr>
						</table>
                       <!-- CTA button-->
						<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="background-color: #002859;">
							<tr>
								<td class="mobile-padding-0-40">
									&nbsp;
								</td>
							</tr>
						</table>
				
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>

<table cellpadding="0" cellspacing="0" border="0" align="center" width="600" class="container" role="presentation" style="margin: 0 auto;">
    <tr>
        <td class="mobile-padding-0-40" align="center" style="padding: 10px 24px 20px;">
           	<table border="0" cellspacing="0" cellpadding="0" role="presentation" width="100%">
										<tr>
											<td width="100%" class="button-cell-full" bgcolor="#e87435" style="border-radius: 10px; -moz-border-radius: 10px; -webkit-border-radius: 10px; background-color: #e87435;text-align: center;">
												<a target="_blank" class="buttonstyles" href="%%=RedirectTo(@SHIPEX_link)=%%" title="SEE ALL ACTIVITIES" style="background: #e87435; border: 1px solid #e87435; padding: 8px 26px; color: #ffffff; font-family: 'Poppins', Arial, sans-serif; font-size: 15px; line-height: 1.1; font-weight:700; text-align: center; text-decoration: none; display: inline-block; border-radius: 10px; -webkit-border-radius: 10px;">SEE ALL ACTIVITIES</a>
											</td>
										</tr>
									</table>
        </td>
    </tr>
</table>
        </td> 
    </tr>
</table>

<!-- ====== END SEA DAY ACTIVITIES COMPONENT ====== -->
